name: Deploy docs to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  build-and-deploy-docs:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Prepare temporary Docusaurus project
        run: |
          mkdir -p .docusaurus-tmp
          cat <<'JSON' > .docusaurus-tmp/package.json
          {
            "name": "wellknown-docs",
            "private": true,
            "scripts": {
              "build": "docusaurus build"
            },
            "dependencies": {
              "@docusaurus/core": "^3.4.0",
              "@docusaurus/preset-classic": "^3.4.0",
              "react": "^18.3.1",
              "react-dom": "^18.3.1"
            }
          }
          JSON

          cat <<'JS' > .docusaurus-tmp/docusaurus.config.js
          // Auto-generated at workflow runtime. For local docs editing, modify docs/*.md.
          const config = {
            title: 'wellknown',
            url: 'https://airnub-labs.github.io',
            baseUrl: '/wellknown/',
            favicon: 'img/favicon.ico',
            organizationName: 'airnub-labs',
            projectName: 'wellknown',
            trailingSlash: false,
            presets: [
              [
                'classic',
                {
                  docs: {
                    path: 'docs',
                    routeBasePath: '/',
                    sidebarPath: require.resolve('./sidebars.js'),
                  },
                  theme: {},
                },
              ],
            ],
          };

          module.exports = config;
          JS

          cat <<'JS' > .docusaurus-tmp/sidebars.js
          module.exports = {
            docs: [{ type: 'autogenerated', dirName: '.' }],
          };
          JS

          mkdir -p .docusaurus-tmp/docs
          cp -R docs/. .docusaurus-tmp/docs/

      - name: Install Docusaurus deps
        working-directory: .docusaurus-tmp
        run: npm install

      - name: Build docs site
        working-directory: .docusaurus-tmp
        run: npm run build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .docusaurus-tmp/build

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
